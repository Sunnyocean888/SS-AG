<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sun Series Travel - Professional Tour System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css');
        
        .gradient-bg {
            background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #f97316 0%, #eab308 100%);
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #ea580c 0%, #ca8a04 100%);
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-white rounded-xl card-shadow p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-orange-600 mb-2">Sun Series Travel Co., Ltd.</h1>
                <p class="text-gray-600">Professional Tour Quotation System - Powered by Airtable</p>
                <div class="flex justify-center items-center gap-4 mt-4 text-sm text-gray-500">
                    <span>Quote #: <span id="quotationNumber"></span></span>
                    <span>‚Ä¢</span>
                    <span>Valid Until: <span id="validUntil"></span></span>
                </div>
            </div>

            <!-- API Configuration -->
            <div class="mb-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">üîß Airtable Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Airtable Base ID</label>
                        <input type="text" id="baseId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="app..." value="appe4FALoSFihKEyl">
                        <p class="text-xs text-gray-500 mt-1">Find at airtable.com/api</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token</label>
                        <input type="password" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="pat...">
                        <p class="text-xs text-gray-500 mt-1">Create at airtable.com/create/tokens</p>
                    </div>
                </div>
                
                <!-- Token Setup Instructions -->
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-semibold text-yellow-800 mb-2">üìã Token Setup Checklist:</h3>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        <li>‚úÖ Go to <a href="https://airtable.com/create/tokens" target="_blank" class="underline">airtable.com/create/tokens</a></li>
                        <li>‚úÖ Create token with scopes: <code>data.records:read</code> and <code>schema.bases:read</code></li>
                        <li>‚úÖ Add your base <code>appe4FALoSFihKEyl</code> to token access</li>
                        <li>‚úÖ Copy the token (starts with <code>pat...</code>)</li>
                    </ul>
                </div>
                
                <div class="mt-4">
                    <button onclick="testConnection()" id="testBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                        Test Connection
                    </button>
                    <div id="connectionStatus" class="ml-3 mt-2"></div>
                </div>
            </div>

            <!-- Client Information -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-blue-500">üë§</span>
                    Client Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Full name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="clientEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input type="tel" id="clientPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="+66 XX XXX XXXX">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nationality</label>
                        <input type="text" id="clientNationality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Country">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Number of Guests</label>
                        <input type="number" min="1" id="groupSize" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500" value="1">
                    </div>
                </div>
            </div>

            <!-- Travel Dates -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-orange-500">üìÖ</span>
                    Travel Dates
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date (Auto-calculated)</label>
                        <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" readonly>
                    </div>
                </div>
            </div>

            <!-- Destinations -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-orange-500">üìç</span>
                    Destinations
                </h2>
                <div class="flex justify-end mb-4">
                    <button onclick="addDestination()" id="addDestBtn" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 text-sm">
                        + Add Destination
                    </button>
                </div>
                <div id="destinationsContainer" class="space-y-4"></div>
            </div>

            <!-- Tours Selection -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-orange-500">üéØ</span>
                    Available Tours
                </h2>
                <div class="mb-4">
                    <button onclick="loadAllTours()" id="loadToursBtn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">
                        <span id="loadToursSpinner" class="spinner" style="display: none;"></span>
                        Load Tours from Airtable
                    </button>
                </div>
                <div id="toursContainer" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </div>

            <!-- Hotels -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-purple-500">üè®</span>
                    Accommodation
                </h2>
                <div class="mb-4">
                    <button onclick="loadHotels()" id="loadHotelsBtn" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm">
                        <span id="loadHotelsSpinner" class="spinner" style="display: none;"></span>
                        Load Hotels from Airtable
                    </button>
                </div>
                <div id="hotelsContainer" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </div>

            <!-- Selected Items Summary -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-green-500">üìã</span>
                    Selected Items & Cost Summary
                </h2>
                <div id="selectedItems" class="bg-gray-50 rounded-lg p-6">
                    <p class="text-gray-500 text-center">No items selected yet</p>
                </div>
            </div>

            <!-- Generated Quotation -->
            <div id="quotationDisplay" class="mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-green-500">üìÑ</span>
                    Generated Quotation
                </h2>
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-green-800">Professional Quotation Ready</h3>
                        <div class="space-x-2">
                            <button onclick="copyQuotation()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">
                                Copy to Clipboard
                            </button>
                            <button onclick="downloadQuotation()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                                Download
                            </button>
                        </div>
                    </div>
                    <pre id="quotationText" class="bg-white p-4 rounded border text-sm whitespace-pre-wrap font-mono max-h-96 overflow-y-auto"></pre>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="border-t pt-6">
                <div class="flex justify-center">
                    <button onclick="generateQuotation()" class="px-8 py-3 btn-gradient text-white rounded-lg font-semibold text-lg shadow-lg transform transition hover:scale-105">
                        Generate Professional Quotation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        window.appData = {
            clientInfo: { name: '', email: '', phone: '', nationality: '' },
            destinations: [{ name: 'Bangkok', nights: 3 }],
            travelDates: { start: '', end: '' },
            groupSize: 1,
            selectedTours: [],
            selectedHotels: [],
            quotationNumber: '',
            validUntil: '',
            apiConfig: { baseId: '', apiKey: '' }
        };

        // Airtable API functions with better error handling
        async function makeAirtableRequest(tableName, params = {}) {
            const baseId = document.getElementById('baseId').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!baseId || !apiKey) {
                alert('Please enter Airtable Base ID and API Key first');
                return null;
            }
            
            const queryString = new URLSearchParams(params).toString();
            const url = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}${queryString ? '?' + queryString : ''}`;
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error(`Access Forbidden (403): Check your API token permissions. Make sure the token has 'data.records:read' and 'schema.bases:read' scopes, and access to base ${baseId}`);
                    } else if (response.status === 404) {
                        throw new Error(`Table '${tableName}' not found (404): Check your table name`);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                return await response.json();
            } catch (error) {
                console.error('Airtable API Error:', error);
                alert(`Error: ${error.message}`);
                return null;
            }
        }

        async function testConnection() {
            const btn = document.getElementById('testBtn');
            const status = document.getElementById('connectionStatus');
            
            btn.disabled = true;
            btn.textContent = 'Testing...';
            status.innerHTML = '<div class="text-blue-600">Testing connection...</div>';
            
            const baseId = document.getElementById('baseId').value;
            const apiKey = document.getElementById('apiKey').value;
            
            // First, let's test if we can reach Airtable at all
            try {
                // Test basic API access by getting base schema
                const schemaUrl = `https://api.airtable.com/v0/meta/bases/${baseId}/tables`;
                const schemaResponse = await fetch(schemaUrl, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (schemaResponse.ok) {
                    const schema = await schemaResponse.json();
                    status.innerHTML = `<div class="text-green-600">‚úÖ API access successful!</div>`;
                    
                    // Show available tables
                    if (schema.tables && schema.tables.length > 0) {
                        const tableList = schema.tables.map(table => `"${table.name}"`).join(', ');
                        status.innerHTML += `<div class="text-sm text-gray-600 mt-2">Available tables: ${tableList}</div>`;
                        
                        // Store the first table name for loading tours
                        window.workingTableName = schema.tables[0].name;
                        status.innerHTML += `<div class="text-sm text-blue-600 mt-1">Will use table: "${window.workingTableName}" for loading tours</div>`;
                    }
                } else {
                    const errorText = await schemaResponse.text();
                    status.innerHTML = `<div class="text-red-600">‚ùå API Error ${schemaResponse.status}: ${schemaResponse.statusText}</div>`;
                    if (schemaResponse.status === 403) {
                        status.innerHTML += `<div class="text-sm text-red-600 mt-2">Permission denied. Please check:<br>
                        1. API token has 'schema.bases:read' scope<br>
                        2. Token has access to base ${baseId}<br>
                        3. Token is not expired</div>`;
                    }
                }
            } catch (error) {
                status.innerHTML = `<div class="text-red-600">‚ùå Network error: ${error.message}</div>`;
                status.innerHTML += `<div class="text-sm text-gray-600 mt-2">Check your internet connection and API credentials</div>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'Test Connection';
        }

        async function loadAllTours() {
            const btn = document.getElementById('loadToursBtn');
            const spinner = document.getElementById('loadToursSpinner');
            const container = document.getElementById('toursContainer');
            
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            container.innerHTML = '<div class="col-span-full text-center text-gray-500">Loading tours...</div>';
            
            // Use the working table name from test connection, or try common names
            const tableName = window.workingTableName || 'Table 1';
            const result = await makeAirtableRequest(tableName, { 
                sort: [{ field: 'Code', direction: 'asc' }]
            });
            
            if (result && result.records) {
                renderTours(result.records);
            } else {
                container.innerHTML = '<div class="col-span-full text-center text-red-500">Failed to load tours. Check your API credentials and run Test Connection first.</div>';
            }
            
            btn.disabled = false;
            spinner.style.display = 'none';
        }

        async function loadHotels() {
            const btn = document.getElementById('loadHotelsBtn');
            const spinner = document.getElementById('loadHotelsSpinner');
            const container = document.getElementById('hotelsContainer');
            
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            container.innerHTML = '<div class="col-span-full text-center text-gray-500">Loading hotels...</div>';
            
            const result = await makeAirtableRequest('Hotels', { 
                filterByFormula: '{Status} = "Active"',
                sort: [{ field: 'Destination', direction: 'asc' }, { field: 'Category', direction: 'asc' }]
            });
            
            if (result && result.records) {
                renderHotels(result.records);
            } else {
                container.innerHTML = '<div class="col-span-full text-center text-red-500">Failed to load hotels</div>';
            }
            
            btn.disabled = false;
            spinner.style.display = 'none';
        }

        function renderTours(tours) {
            const container = document.getElementById('toursContainer');
            
            if (!tours || tours.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500">No tours found</div>';
                return;
            }
            
            const html = tours.map(tour => {
                const fields = tour.fields;
                const isSelected = window.appData.selectedTours.some(t => t.id === tour.id);
                const price = getPriceForGroupSize(fields, window.appData.groupSize);
                
                // Get tour name from your field structure
                const tourName = fields['Bangkok Tour list'] || fields['Phuket Tour list'] || fields['Tour_Name'] || 'Unknown Tour';
                const tourCode = fields['Code'] || 'N/A';
                const tourType = fields['Type'] || 'Tour';
                const duration = fields['Duration'] || 'N/A';
                
                return `
                    <div class="border rounded-lg p-4 cursor-pointer transition-all ${isSelected ? 'border-orange-500 bg-orange-50' : 'border-gray-200 hover:border-orange-300'}" 
                         onclick="toggleTour('${tour.id}', ${JSON.stringify(fields).replace(/"/g, '&quot;')})">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-semibold text-gray-900">${tourCode}</div>
                            <div class="text-orange-600 font-bold">THB ${price.toLocaleString()}</div>
                        </div>
                        <h3 class="font-medium text-gray-800 mb-2">${tourName}</h3>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="inline-flex items-center mr-4">
                                <span class="mr-1">üéØ</span> ${tourType}
                            </span>
                            <span class="inline-flex items-center">
                                <span class="mr-1">‚è∞</span> ${duration}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            ${window.appData.groupSize} guest(s) √ó THB ${price.toLocaleString()} = THB ${(price * window.appData.groupSize).toLocaleString()}
                        </div>
                        ${isSelected ? '<div class="mt-2 text-xs font-medium text-orange-600">‚úì Selected</div>' : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderHotels(hotels) {
            const container = document.getElementById('hotelsContainer');
            
            if (!hotels || hotels.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500">No hotels found</div>';
                return;
            }
            
            const html = hotels.map(hotel => {
                const fields = hotel.fields;
                const isSelected = window.appData.selectedHotels.some(h => h.id === hotel.id);
                
                return `
                    <div class="border rounded-lg p-4 cursor-pointer transition-all ${isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300'}" 
                         onclick="toggleHotel('${hotel.id}', ${JSON.stringify(fields).replace(/"/g, '&quot;')})">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-semibold text-purple-700">${fields.Category}</div>
                            <div class="text-purple-600 font-bold">THB ${fields.Rate_Per_Night.toLocaleString()}/night</div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="inline-flex items-center">
                                <span class="mr-1">üìç</span> ${fields.Destination}
                            </span>
                        </div>
                        ${isSelected ? '<div class="mt-2 text-xs font-medium text-purple-600">‚úì Selected</div>' : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function getPriceForGroupSize(tourFields, groupSize) {
            // Match your actual field names from the screenshot
            if (groupSize === 1 && tourFields['Price per person : THB']) return tourFields['Price per person : THB'];
            if (groupSize <= 3 && tourFields['Price per 2 - 3 Pax']) return tourFields['Price per 2 - 3 Pax'];
            if (groupSize <= 6 && tourFields['Price per 4 - 6 Pax']) return tourFields['Price per 4 - 6 Pax'];
            if (groupSize <= 9 && tourFields['Price per 7 - 9 Pax']) return tourFields['Price per 7 - 9 Pax'];
            if (tourFields['Price per 10+ Pax']) return tourFields['Price per 10+ Pax'];
            return tourFields['Price per person : THB'] || 0;
        }

        function toggleTour(tourId, tourFields) {
            const existingIndex = window.appData.selectedTours.findIndex(t => t.id === tourId);
            
            if (existingIndex !== -1) {
                window.appData.selectedTours.splice(existingIndex, 1);
            } else {
                window.appData.selectedTours.push({
                    id: tourId,
                    fields: tourFields
                });
            }
            
            loadAllTours(); // Refresh display
            updateSelectedItems();
        }

        function toggleHotel(hotelId, hotelFields) {
            const existingIndex = window.appData.selectedHotels.findIndex(h => h.id === hotelId);
            
            if (existingIndex !== -1) {
                window.appData.selectedHotels.splice(existingIndex, 1);
            } else {
                window.appData.selectedHotels.push({
                    id: hotelId,
                    fields: hotelFields
                });
            }
            
            loadHotels(); // Refresh display
            updateSelectedItems();
        }

        function updateSelectedItems() {
            const container = document.getElementById('selectedItems');
            
            if (window.appData.selectedTours.length === 0 && window.appData.selectedHotels.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No items selected yet</p>';
                return;
            }
            
            let totalCost = 0;
            let html = '<div class="space-y-4">';
            
            // Selected Tours
            if (window.appData.selectedTours.length > 0) {
                html += '<div><h3 class="font-semibold text-gray-800 mb-2">Selected Tours:</h3>';
                window.appData.selectedTours.forEach(tour => {
                    const price = getPriceForGroupSize(tour.fields, window.appData.groupSize);
                    const tourTotal = price * window.appData.groupSize;
                    totalCost += tourTotal;
                    
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <div>
                                <div class="font-medium">${tour.fields.Code}: ${tour.fields['Bangkok Tour list'] || tour.fields['Phuket Tour list'] || 'Tour'}</div>
                                <div class="text-sm text-gray-600">${tour.fields.Type} ‚Ä¢ ${tour.fields.Duration}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">THB ${tourTotal.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">${window.appData.groupSize} √ó ${price.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Selected Hotels
            if (window.appData.selectedHotels.length > 0) {
                html += '<div><h3 class="font-semibold text-gray-800 mb-2">Selected Hotels:</h3>';
                window.appData.selectedHotels.forEach(hotel => {
                    const nights = 3; // Default, should be calculated based on destination
                    const hotelTotal = hotel.fields.Rate_Per_Night * nights;
                    totalCost += hotelTotal;
                    
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <div>
                                <div class="font-medium">${hotel.fields.Category}</div>
                                <div class="text-sm text-gray-600">${hotel.fields.Destination} ‚Ä¢ ${nights} nights</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">THB ${hotelTotal.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">${nights} nights √ó ${hotel.fields.Rate_Per_Night.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Total Cost
            html += `
                <div class="border-t-2 border-gray-300 pt-4">
                    <div class="flex justify-between items-center">
                        <div class="text-lg font-bold text-gray-800">Total Cost:</div>
                        <div class="text-xl font-bold text-green-600">THB ${totalCost.toLocaleString()}</div>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        Per person: THB ${(totalCost / window.appData.groupSize).toLocaleString()}
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function addDestination() {
            window.appData.destinations.push({ name: 'Bangkok', nights: 2 });
            renderDestinations();
        }

        function renderDestinations() {
            const container = document.getElementById('destinationsContainer');
            const destinations = ['Bangkok', 'Phuket', 'Chiang Mai', 'Krabi'];
            
            const html = window.appData.destinations.map((dest, index) => `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex gap-4 items-start">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Destination ${index + 1}</label>
                            <select onchange="updateDestination(${index}, 'name', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                                ${destinations.map(d => `<option value="${d}" ${d === dest.name ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                        </div>
                        <div class="w-32">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nights</label>
                            <input type="number" min="1" max="14" value="${dest.nights}" onchange="updateDestination(${index}, 'nights', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                        </div>
                        ${window.appData.destinations.length > 1 ? `
                            <button onclick="removeDestination(${index})" class="text-red-500 hover:text-red-700 p-2 mt-6">
                                <span>√ó</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function updateDestination(index, field, value) {
            window.appData.destinations[index][field] = field === 'nights' ? parseInt(value) : value;
            renderDestinations();
        }

        function removeDestination(index) {
            if (window.appData.destinations.length > 1) {
                window.appData.destinations.splice(index, 1);
                renderDestinations();
            }
        }

        function generateQuotation() {
            const totalCost = calculateTotalCost();
            
            let quotationText = `
SUN SERIES TRAVEL CO., LTD.
PROFESSIONAL THAILAND TOUR QUOTATION
====================================

QUOTATION NO: ${window.appData.quotationNumber}
DATE: ${new Date().toLocaleDateString('en-GB')}
VALID UNTIL: ${new Date(window.appData.validUntil).toLocaleDateString('en-GB')}

CLIENT INFORMATION:
==================
Name: ${document.getElementById('clientName').value || 'N/A'}
Email: ${document.getElementById('clientEmail').value || 'N/A'}
Phone: ${document.getElementById('clientPhone').value || 'N/A'}
Nationality: ${document.getElementById('clientNationality').value || 'N/A'}

TOUR DETAILS:
=============
Group Size: ${window.appData.groupSize} guest(s)
Travel Period: ${document.getElementById('startDate').value} to ${document.getElementById('endDate').value}

SELECTED TOURS:
===============
`;

            if (window.appData.selectedTours.length > 0) {
                window.appData.selectedTours.forEach(tour => {
                    const price = getPriceForGroupSize(tour.fields, window.appData.groupSize);
                    const tourTotal = price * window.appData.groupSize;
                    
                    quotationText += `
‚Ä¢ ${tour.fields.Code}: ${tour.fields['Bangkok Tour list'] || tour.fields['Phuket Tour list'] || 'Tour'}
  Type: ${tour.fields.Type || 'N/A'}
  Duration: ${tour.fields.Duration || 'N/A'}
  Cost: THB ${tourTotal.toLocaleString()} (${window.appData.groupSize} guests √ó ${price.toLocaleString()})
`;
                });
            } else {
                quotationText += 'No tours selected\n';
            }

            quotationText += `
SELECTED ACCOMMODATION:
======================
`;

            if (window.appData.selectedHotels.length > 0) {
                window.appData.selectedHotels.forEach(hotel => {
                    const nights = 3; // Should be calculated based on destination
                    const hotelTotal = hotel.fields.Rate_Per_Night * nights;
                    
                    quotationText += `
‚Ä¢ ${hotel.fields.Category}
  Destination: ${hotel.fields.Destination}
  Rate: THB ${hotel.fields.Rate_Per_Night.toLocaleString()}/night
  Duration: ${nights} nights
  Total: THB ${hotelTotal.toLocaleString()}
`;
                });
            } else {
                quotationText += 'No hotels selected\n';
            }

            quotationText += `
COST SUMMARY:
=============
Total Package Cost: THB ${totalCost.toLocaleString()}
Cost per Person: THB ${(totalCost / window.appData.groupSize).toLocaleString()}

TERMS & CONDITIONS:
==================
‚Ä¢ This quotation is valid until ${new Date(window.appData.validUntil).toLocaleDateString('en-GB')}
‚Ä¢ Prices are subject to change based on availability
‚Ä¢ Full payment required 7 days before departure
‚Ä¢ Cancellation policy applies as per company terms
‚Ä¢ All tours are subject to weather conditions

CONTACT INFORMATION:
===================
Sun Series Travel Co., Ltd.
Email: info@sunseriestravel.com
Phone: +66 (0) 2-XXX-XXXX
License: TAT License No. XXXX

Generated on: ${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB')}
Data powered by Airtable
`;

            document.getElementById('quotationText').textContent = quotationText;
            document.getElementById('quotationDisplay').style.display = 'block';
        }

        function calculateTotalCost() {
            let total = 0;
            
            // Tours cost
            window.appData.selectedTours.forEach(tour => {
                const price = getPriceForGroupSize(tour.fields, window.appData.groupSize);
                total += price * window.appData.groupSize;
            });
            
            // Hotels cost
            window.appData.selectedHotels.forEach(hotel => {
                const nights = 3; // Should be calculated based on destination
                total += hotel.fields.Rate_Per_Night * nights;
            });
            
            return total;
        }

        function copyQuotation() {
            const quotationText = document.getElementById('quotationText').textContent;
            navigator.clipboard.writeText(quotationText).then(() => {
                alert('Quotation copied to clipboard!');
            });
        }

        function downloadQuotation() {
            const quotationText = document.getElementById('quotationText').textContent;
            const blob = new Blob([quotationText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Quotation_${window.appData.quotationNumber}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            // Generate quotation number
            const date = new Date();
            const qNumber = 'SST-' + date.getFullYear() + String(date.getMonth() + 1).padStart(2, '0') + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            window.appData.quotationNumber = qNumber;
            document.getElementById('quotationNumber').textContent = qNumber;
            
            // Set valid until date (30 days from now)
            date.setDate(date.getDate() + 30);
            const validUntil = date.toISOString().split('T')[0];
            window.appData.validUntil = validUntil;
            document.getElementById('validUntil').textContent = date.toLocaleDateString('en-GB');
            
            // Bind events
            document.getElementById('groupSize').addEventListener('input', function(e) {
                window.appData.groupSize = parseInt(e.target.value);
                updateSelectedItems();
                // Refresh tours display if loaded
                if (document.getElementById('toursContainer').children.length > 0) {
                    loadAllTours();
                }
            });
            
            // Render initial destinations
            renderDestinations();
        });
    </script>
</body>
</html>
